<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; }
  body { margin: 0; background: #f0f0f3; font-family: system-ui, sans-serif; }

  .toolbar {
    position: sticky; top: 0; z-index: 10;
    background: #f0f0f3; padding: 10px 14px;
    border-bottom: 1px solid #ddd;
  }
  .toolbar input {
    width: 100%; padding: 8px 12px; border-radius: 8px;
    border: 1px solid #ccc; font-size: 14px; outline: none;
    background: white;
  }
  .toolbar input:focus { border-color: #888; }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 14px; padding: 14px;
  }

  .card {
    background: white; border-radius: 12px; overflow: hidden;
    box-shadow: 0 2px 6px rgba(0,0,0,.1); cursor: pointer;
    transition: transform .15s, box-shadow .15s;
    border: 2px solid transparent;
  }
  .card:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,.15); }
  .card.selected { border-color: #4a90d9; box-shadow: 0 0 0 3px rgba(74,144,217,.25); }

  .img-wrap {
    width: 100%; height: 230px;
    position: relative; overflow: hidden; background: #e8e8e8;
    display: flex; align-items: center; justify-content: center;
  }
  .img-wrap img {
    position: absolute; inset: 0;
    width: 100%; height: 100%; object-fit: cover;
    opacity: 0; transition: opacity .3s;
  }
  .img-wrap img.loaded { opacity: 1; }
  .fallback {
    font-size: 52px; color: #bbb; user-select: none;
  }

  .info { padding: 10px 12px; }
  .name {
    font-weight: 600; font-size: 14px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .meta {
    font-size: 12px; color: #888; margin-top: 2px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }

  .empty {
    grid-column: 1 / -1; text-align: center;
    padding: 60px 20px; color: #aaa; font-size: 15px;
  }
</style>
</head>
<body>

<div class="toolbar">
  <input type="search" id="search" placeholder="Search creatorsâ€¦" />
</div>
<div id="grid" class="grid"></div>

<script>
grist.ready({
  requiredAccess: 'read table',
  columns: [
    {name: 'photo', title: 'Creator DP',   type: 'Attachments'},
    {name: 'name',  title: 'Creator Name', type: 'Text', optional: true},
    {name: 'meta',  title: 'Subtitle',     type: 'Text', optional: true},
  ]
});

let allCards = [];
let selectedRowId = null;

async function getToken() {
  const info = await grist.docApi.getAccessToken({readOnly: true});
  return info; // {token, baseUrl}
}

grist.onRecord((record) => {
  if (!record) return;
  selectedRowId = record.id;
  document.querySelectorAll('.card').forEach(c => {
    c.classList.toggle('selected', +c.dataset.rowId === selectedRowId);
  });
});

async function render(records) {
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  allCards = [];

  if (!records || !records.length) {
    grid.innerHTML = '<div class="empty">No records found.</div>';
    return;
  }

  const seen = new Set();
  for (const r of records) {
    if (seen.has(r.id)) continue;
    seen.add(r.id);
    const row = grist.mapColumnNames(r);
    if (!row) continue;

    // photo may be null/empty â€” still show card with fallback
    const attachIds = (row.photo && Array.isArray(row.photo)) ? row.photo : [];
    allCards.push({
      rowId: r.id,
      name: row.name || '',
      meta: row.meta || '',
      attachIds,
    });
  }

  await applyFilter(document.getElementById('search').value);
}

async function applyFilter(query) {
  const grid = document.getElementById('grid');
  grid.innerHTML = '';

  const q = query.trim().toLowerCase();
  const filtered = q ? allCards.filter(c => c.name.toLowerCase().includes(q)) : allCards;

  if (!filtered.length) {
    grid.innerHTML = '<div class="empty">No creators match your search.</div>';
    return;
  }

  // Single fresh token for this render pass
  let tokenInfo = await getToken();

  for (const c of filtered) {
    const card = document.createElement('div');
    card.className = 'card' + (c.rowId === selectedRowId ? ' selected' : '');
    card.dataset.rowId = c.rowId;
    card.onclick = () => grist.setCursorPos({rowId: c.rowId});

    // Always render fallback; overlay image on top if attachment exists
    card.innerHTML = `
      <div class="img-wrap">
        <div class="fallback">ðŸ‘¤</div>
        ${c.attachIds.length ? `<img alt="${escHtml(c.name)}">` : ''}
      </div>
      <div class="info">
        <div class="name">${escHtml(c.name) || 'â€”'}</div>
        ${c.meta ? `<div class="meta">${escHtml(c.meta)}</div>` : ''}
      </div>
    `;

    if (c.attachIds.length) {
      const img = card.querySelector('img');
      let retried = false;

      async function loadImg(tok) {
        img.src = `${tok.baseUrl}/attachments/${c.attachIds[0]}/download?auth=${tok.token}`;
      }

      img.onload = () => {
        img.classList.add('loaded');
      };
      img.onerror = async () => {
        if (!retried) {
          retried = true;
          try {
            tokenInfo = await getToken(); // refresh token
            await loadImg(tokenInfo);
          } catch {
            // leave fallback visible
          }
        }
        // if retry also fails, fallback emoji stays visible â€” do nothing
      };

      await loadImg(tokenInfo);
    }

    grid.appendChild(card);
  }
}

function escHtml(str) {
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}

document.getElementById('search').addEventListener('input', e => applyFilter(e.target.value));
grist.onRecords(render);
</script>
</body>
</html>
