<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
<style>
body {margin:0;background:#f2f2f2;font-family:system-ui}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
  gap:14px;
  padding:14px;
}
.card{
  background:white;
  border-radius:12px;
  overflow:hidden;
  box-shadow:0 3px 8px rgba(0,0,0,.12);
  cursor:pointer;
  transition:.15s;
}
.card:hover{transform:translateY(-2px)}
.card img{
  width:100%;
  height:230px;
  object-fit:cover;
  background:#ddd;
}
.name{
  padding:10px;
  font-weight:600;
  font-size:14px;
}
</style>
</head>
<body>
<div id="grid" class="grid"></div>
<script>
grist.ready({
  requiredAccess: 'read table',
  columns: [
    {name: 'photo', title: 'Creator DP', type: 'Attachments'},
    {name: 'name', title: 'Creator Name', type: 'Text', optional: true}
  ]
});

async function render(records) {
  const grid = document.getElementById('grid');
  grid.innerHTML = '';

  if (!records || !records.length) return;

  // Fetch token once for the whole render pass
  const {token, baseUrl} = await grist.docApi.getAccessToken({readOnly: true});

  const seen = new Set();
  for (const r of records) {
    if (seen.has(r.id)) continue;
    seen.add(r.id);

    const row = grist.mapColumnNames(r);
    if (!row || !row.photo || !row.photo.length) continue;

    const attachId = row.photo[0];
    const url = `${baseUrl}/attachments/${attachId}/download?auth=${token}`;

    const card = document.createElement('div');
    card.className = 'card';
    card.onclick = () => grist.setCursorPos({rowId: r.id});
    card.innerHTML = `
      <img src="${url}" alt="${row.name || ''}">
      <div class="name">${row.name || ''}</div>
    `;
    grid.appendChild(card);
  }
}

// This must be at the top level, outside any function
grist.onRecords(render);
</script>
</body>
</html>
