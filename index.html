<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; }
  body { margin: 0; background: #f0f0f3; font-family: system-ui, sans-serif; }

  .toolbar {
    position: sticky; top: 0; z-index: 10;
    background: #f0f0f3; padding: 10px 14px;
    border-bottom: 1px solid #ddd;
    display: flex; gap: 8px; align-items: center;
  }
  .toolbar input {
    flex: 1; padding: 8px 12px; border-radius: 8px;
    border: 1px solid #ccc; font-size: 14px; outline: none;
    background: white;
  }
  .toolbar input:focus { border-color: #4a90d9; }
  .count { font-size: 12px; color: #999; white-space: nowrap; }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 12px; padding: 14px;
  }

  .card {
    background: white; border-radius: 12px; overflow: hidden;
    box-shadow: 0 2px 6px rgba(0,0,0,.08); cursor: pointer;
    transition: transform .15s, box-shadow .15s;
    border: 2px solid transparent; position: relative;
  }
  .card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,.15); }
  .card.selected { border-color: #4a90d9; box-shadow: 0 0 0 3px rgba(74,144,217,.2); }
  .card.selected::after {
    content: '‚úì';
    position: absolute; top: 8px; right: 8px;
    width: 22px; height: 22px; border-radius: 50%;
    background: #4a90d9; color: white;
    font-size: 12px; font-weight: bold;
    display: flex; align-items: center; justify-content: center;
    line-height: 22px; text-align: center;
  }

  .img-wrap {
    width: 100%; height: 220px; background: #e8e8e8;
    position: relative; overflow: hidden;
    display: flex; align-items: center; justify-content: center;
  }
  .img-wrap img {
    position: absolute; inset: 0;
    width: 100%; height: 100%; object-fit: cover;
    opacity: 0; transition: opacity .25s;
  }
  .img-wrap img.loaded { opacity: 1; }
  .fallback { font-size: 48px; color: #ccc; }

  .info { padding: 10px 12px 12px; }
  .name {
    font-weight: 600; font-size: 13px; color: #222;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .meta {
    font-size: 11px; color: #999; margin-top: 3px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }

  .empty {
    grid-column: 1/-1; text-align: center;
    padding: 60px 20px; color: #bbb; font-size: 14px;
  }
  .empty .icon { font-size: 40px; margin-bottom: 8px; }
</style>
</head>
<body>

<div class="toolbar">
  <input type="search" id="search" placeholder="Search creators‚Ä¶" />
  <span class="count" id="count"></span>
</div>
<div id="grid" class="grid"></div>

<script>
grist.ready({
  requiredAccess: 'read table',
  columns: [
    {name: 'photo', title: 'Creator DP',   type: 'Attachments'},
    {name: 'name',  title: 'Creator Name', type: 'Text', optional: true},
    {name: 'meta',  title: 'Subtitle',     type: 'Text', optional: true},
  ]
});

let allCards = [];
let selectedRowId = null;
let currentToken = '';
let currentBaseUrl = '';

async function refreshToken() {
  const info = await grist.docApi.getAccessToken({readOnly: true});
  currentToken = info.token;
  currentBaseUrl = info.baseUrl;
}

grist.onRecord((record) => {
  if (!record) return;
  selectedRowId = record.id;
  document.querySelectorAll('.card').forEach(c =>
    c.classList.toggle('selected', +c.dataset.rowId === selectedRowId)
  );
});

async function render(records) {
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  allCards = [];

  if (!records?.length) {
    grid.innerHTML = '<div class="empty"><div class="icon">üë•</div>No records found.</div>';
    document.getElementById('count').textContent = '';
    return;
  }

  const seen = new Set();
  for (const r of records) {
    if (seen.has(r.id)) continue;
    seen.add(r.id);
    const row = grist.mapColumnNames(r);
    if (!row) continue;
    const attachIds = Array.isArray(row.photo) ? row.photo : [];
    allCards.push({
      rowId: r.id,
      name: row.name != null ? String(row.name) : '',
      meta: row.meta != null ? String(row.meta) : '',
      attachIds,
    });
  }

  applyFilter(document.getElementById('search').value);
}

function applyFilter(query) {
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  const q = query.trim().toLowerCase();
  const filtered = q
    ? allCards.filter(c =>
        c.name.toLowerCase().includes(q) || c.meta.toLowerCase().includes(q)
      )
    : allCards;

  document.getElementById('count').textContent =
    filtered.length !== allCards.length
      ? `${filtered.length} of ${allCards.length}`
      : `${allCards.length} creators`;

  if (!filtered.length) {
    grid.innerHTML = '<div class="empty"><div class="icon">üîç</div>No creators match your search.</div>';
    return;
  }

  const frag = document.createDocumentFragment();
  const imgQueue = [];

  for (const c of filtered) {
    const card = document.createElement('div');
    card.className = 'card' + (c.rowId === selectedRowId ? ' selected' : '');
    card.dataset.rowId = c.rowId;
    card.onclick = () => {
      selectedRowId = c.rowId;
      document.querySelectorAll('.card').forEach(el =>
        el.classList.toggle('selected', +el.dataset.rowId === c.rowId)
      );
      grist.setCursorPos({rowId: c.rowId});
      grist.setSelectedRows([c.rowId]);
    };

    card.innerHTML = `
      <div class="img-wrap">
        <div class="fallback">üë§</div>
        ${c.attachIds.length ? `<img alt="${escHtml(c.name)}">` : ''}
      </div>
      <div class="info">
        <div class="name">${escHtml(c.name) || '‚Äî'}</div>
        ${c.meta ? `<div class="meta">${escHtml(c.meta)}</div>` : ''}
      </div>
    `;

    if (c.attachIds.length) {
      imgQueue.push({img: card.querySelector('img'), attachId: c.attachIds[0]});
    }

    frag.appendChild(card);
  }

  grid.appendChild(frag);

  // Load images with concurrency limit to avoid Grist's 10-request cap
  loadImagesBatched(imgQueue, 6);
}

async function loadImagesBatched(queue, batchSize) {
  await refreshToken();
  for (let i = 0; i < queue.length; i += batchSize) {
    const batch = queue.slice(i, i + batchSize);
    await Promise.all(batch.map(({img, attachId}) => loadOneImage(img, attachId)));
  }
}

async function loadOneImage(img, attachId, isRetry = false) {
  return new Promise(async (resolve) => {
    img.onload = () => { img.classList.add('loaded'); resolve(); };
    img.onerror = async () => {
      if (!isRetry) {
        // Refresh token and retry once
        try {
          await refreshToken();
          await loadOneImage(img, attachId, true);
        } catch { /* fallback stays */ }
      }
      resolve();
    };
    img.src = `${currentBaseUrl}/attachments/${attachId}/download?auth=${currentToken}`;
  });
}

function escHtml(s) {
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

document.getElementById('search').addEventListener('input', e => applyFilter(e.target.value));
grist.onRecords(render);
</script>
</body>
</html>
